name: Build EXE and Push to Repo

on:
  push:
    paths:
      - 'main.py'      # main.py가 수정될 때만 작동
      - 'bible.json'   # 혹은 데이터가 수정될 때
  workflow_dispatch:   # 수동 실행 가능

permissions:
  contents: write      # 로봇에게 '파일 쓰기' 권한 부여 (중요!)

jobs:
  build-and-push:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller fastapi uvicorn

    # 1. 실행 파일 만들기 (.exe)
    - name: Build EXE
      run: pyinstaller --onefile --noconsole --name "bible-server-win" main.py

    # 2. dist 폴더에 있는 exe를 밖으로 꺼내면서 txt로 이름 바꾸기
    - name: Move and Rename
      run: |
        Move-Item -Path "dist/bible-server-win.exe" -Destination "bible-server-win.txt" -Force

    # 3. [핵심] 깃허브 저장소에 자동 업로드 (Commit & Push)
    - name: Commit and Push changes
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add bible-server-win.txt
        git commit -m "Auto-build: Update bible-server-win.txt" || echo "No changes to commit"
        git push
